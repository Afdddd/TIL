# CAP 정리

<br>

**CAP 이론**은 Network로 연결된 분산 데이터 베이스 시스템은 **일관성(Consistency)**, **가용성(Availability)**, **분할내성(Partition Tolerance)** 이라는 세 가지 속성 중에서 두 가지만 동시에 만족할 수 있다는 원칙이다.

<br>

### CAP 속성

1. **일관성(Consistency)**:

- 분산 시스템의 모든 노드가 같은 시간에 동일한 데이터를 보장한다는 의미
- 즉, 한 노드에서 데이터를 수정하면, 그 수정 사항이 즉시 다른 모든 노드에도 반영되어 모든 사용자는 언제나 일관된 데이터를 볼 수 있다.

<br>

2. **가용성(Availability)**:
- 모든 요청이 항상 성공적으로 응답할 수 있어야 한다는 의미
- 즉, 시스템의 일부에 문제가 있더라도 서비스가 중단되지 않고, 요청에 대해 항상 응답을 제공해야한다.

<br>

3. **분할내성(Partition Tolerance)**:
- 네트워크가 분할되더라도 시스템이 계속해서 동작할 수 있어야 한다는 의미
- 분산 시스템에서는 네트워크 장애로 인해 일부 노드 간 통신이 불가능할 수 있는데, 이런 상황에서도 시스템은 멈추지 않고 계속해서 작동해야 한다.

```
💡 네트워크 분리는 시스템의 컴퓨터나 장치들이 서로 다른 네트워크에서 운영되는 것을 의미

- 물리적 네트워크 분리 : 독립적인 하드웨어 장비(스위치, 라우터)를 사용해 네트워크를 분리한 경우
- 논리적 네트워크 분리 : 서브넷을 사용하여 하나의 물리적 네트워크를 여러 개의 논리적 네트워크로 분리한 경우
  (예  VPC를 사용해 웹 애플리케이션과 데이터베이스를 서로 다른 서브넷에 배치하여 보안을 강화하는 경우)
```

<br>

### 세 가지 속성 만족할 수 없는 이유
<br>

분산 데이터베이스 시스템에서의 CAP 이론은 **세 가지 속성 중에서 두 가지만 선택할 수 있고, 세 가지 모두를 동시에 만족시키는 것은 불가능하다**는 것이다.

그 이유는 **네트워크가 분할되었을 때 일관성과 가용성 중 하나를 포기**해야 하기 때문이다.

네트워크 분할이 일어나면 분산 시스템의 노드들이 서로 통신할 수 없게 된다. 이때 두 가지 선택지가 생긴다.

1. **일관성을 유지** : 모든 노드가 동일한 최신 데이터를 제공하기 위해서는, 네트워크가 복구될 때까지 데이터를 업데이트하거나 읽는 것을 멈춰야한다.  즉, 일부 요청은 응답할 수 없게 되어 가용성을 포기해야한다.
2. **가용성을 유지 :** 각 노드는 네트워크가 분리된 상태에서도 사용자의 요청에 즉시 응답할 수 있다. 하지만 이 경우, 각 노드에서 서로 다른 데이터를 제공할 가능성이 있어 일관성을 포기하게 된다.

따라서, 네트워크 분할(Partition Tolerance)이 발생하면, **일관성**과 **가용성**을 동시에 유지하는 것이 불가능해지는 것이다.

<br>

### 분할내성은 필수인 이유

분산 시스템에서는  네트워크 분할이 언제든지 발생할 수 있기 때문에 분할내성을 기본적으로 선택할 수밖에 없다.네트워크 장애나 지연은 예측할 수 없으며, 시스템은 이러한 상황에서도 동작할 수 있어야 합니다.

따라서, **분할내성(Partition Tolerance)**은 대부분의 분산 시스템에서 필수로 고려되며, 이 경우 **일관성(Consistency)**과 **가용성(Availability)** 중 하나를 선택해야 한다.

<br>

### 속성 선택지

![image.png](/img/cap.png)

1. **CP(Consistency + Partition Tolerance)**:
    
    
    - 일관성과 분할내성을 우선시하는 시스템. 네트워크 분할이 발생하더라도 모든 노드에서 일관된 데이터를 제공하려고 하지만, 가용성을 포기할 수 있다. 즉, 네트워크가 분할되면 일부 요청은 거부될 수 있다.
    - HBase, Redis, mongoDB

<br>

2. **AP (Availability + Partition Tolerance)**:
    - 가용성과 분할내성을 우선시하는 시스템. 네트워크 분할이 발생하더라도 시스템은 요청에 대한 응답을 계속 제공하지만, 일관성을 보장하지 않을 수 있다.
    - Cassandra, DynamoDB

<br>

3. **CA (Consistency + Availability)**:
    - 일관성과 가용성을 우선시하는 시스템. 네트워크 분할 상황이 발생하지 않는 환경에서 동작하는 시스템으로, 모든 요청에 대해 일관된 데이터를 제공하고 항상 응답할 수 있지만, 분할내성이 없어 분산 시스템에는 맞지 않는다.
    - Mysql,  postgre, MaraiDB 같은 단일 서버 시스템